%---------------------------------------------
% This document is for pdflatex
%---------------------------------------------
\documentclass[11pt]{article}

\usepackage{amsmath,amsfonts,amssymb,graphicx,setspace,authblk}
\usepackage{float}
\usepackage[running]{lineno}
\usepackage[vmargin=1in,hmargin=1in]{geometry}
\usepackage[sc]{mathpazo} %Like Palatino with extensive math support

\usepackage[authoryear]{natbib}

\graphicspath{ {./../genetic-diversity/figures/} {./../community-turnover/figures/} }

\usepackage{enumitem}
\setlist{topsep=.125em,itemsep=-0.15em,leftmargin=0.75cm}

\usepackage{gensymb}

\usepackage[compact]{titlesec} 

\usepackage{bm,mathrsfs}

\usepackage{ifpdf}
\ifpdf
\DeclareGraphicsExtensions{.pdf,.png,.jpg}
\usepackage{epstopdf}
\else
\DeclareGraphicsExtensions{.eps}
\fi

\renewcommand{\floatpagefraction}{0.98}
\renewcommand{\topfraction}{0.99}
\renewcommand{\textfraction}{0.05}

\clubpenalty = 10000
\widowpenalty = 10000

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
%%% Just for commenting
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\usepackage[usenames]{color}
\newcommand{\new}{\textcolor{red}}
\newcommand{\spe}{\textcolor{blue}}
\newcommand{\comment}{\textcolor{black}}

\newcommand{\be}{\begin{equation}}
\newcommand{\ee}{\end{equation}}
\newcommand{\ba}{\begin{equation} \begin{aligned}}
\newcommand{\ea}{\end{aligned} \end{equation}}

\def\X{\mathbf{X}}

\floatstyle{boxed}
\newfloat{Box}{tbph}{box}

\title{\textbf{ Matching the forecast horizon with the relevant ecological processes }}

\author[1]{Peter B. Adler}  %\thanks{Corresponding author. Department of Wildland Resources and the Ecology Center, Utah State University, Logan, Utah Email: peter.adler@usu.edu}}
\author[2]{Ethan White}
\author[1]{Michael Cortez?}
\author[3]{Heather Lynch?}
\affil[1]{Department of Wildland Resources and the Ecology Center, Utah State University, Logan, Utah}
\affil[2]{some shitty Florida joint}

\renewcommand\Authands{ and }

% \date{Last compile: \today} 

\sloppy

\renewcommand{\baselinestretch}{1.25}

\begin{document}

\maketitle

\linenumbers

\section*{Abstract}

stuff

\textbf{\large{Keywords:}} dispersal, ecological forecasting, eco-evolutionary dynamics, global change, selection

\section*{Introduction}

Forecasting is increasingly recognized as important to the application and advancement of ecological research.
Forecasts are necessary to guide environmental policy and management
decisions about mitigation and adaption to global change \citep{clark_ecological_2001,mouquet_review:_2015,dietze_iterative_2018}.
But forecasts can also advance understanding of the processes governing ecological systems by providing rigorous tests of 
model predictions \citep{houlahan_priority_2017,dietze_prediction_2017,dietze_iterative_2018}.
The combined benefits of informing policy and management and advancing basic research 
makes forecasting an important priority for ecological research.

The models used for ecological forecasting have traditionally been based on either time-series approaches or space-for-time substitutions.
The time-series approach involves fitting models to long-term datasets to describe the temporal dynamics of a system.  We then use those
dynamic models to make predictions about what will happen in the future. This is the common approach for population forecasts and includes 
both process-based and data-driven models (e.g., \citep{ward_complexity_2014}). Whether process-based or
data-driven, time-series models typically capture processes operating on interannual time-scales, such as birth, death, 
small scale dispersal events, and short-term responses to environmental conditions.


Space-for-time substitution approaches begin by describing how an ecological variable of interest, such as occupancy or productivity, 
varies across sites experiencing different environmental conditions. These spatial relationships between environment and ecological 
response are assumed to also hold for changes at a site through time. To make a forecast, we first predict the future
environmental conditions and then determinie the associated ecological response, based on the observed spatial relationship. 
Most forecasts for future species distributions and biodiversity are based on this approach. 
Space-for-time models capture processes operating over long time periods, such as
immigration, extinction, and responses to large or prolonged environmental changes. Although both of these approaches are
widely used, there has been little discussion of their advantages and disadvantages for guiding policy decisions or 
advancing our understanding of ecological dynamics \citep{harris_forecasting_2018} (but see Renwick et al ??).

Whether historical dynamics, contemporary spatial patterns, or spme combination of the two will serve as the best source of 
information for forecasting may depend on how far into the future we are attempting to forecast \citep{harris_forecasting_2018}. 
This potential dependency on the "forecast horizon"; ()\textit{sensu} citation)
reflects lags in the response of ecological conditions to environmental change, shifts in the importance of ecological processes with
time scale \citep{levin_1992,rosenzweig_1995}, and differences between time-series and spatial gradients in the range of 
environmental conditions represented in observed data.
At short forecast horizons (days to years), dynamics will reflect the physiological and demographic responses of 
the organisms present at a site more than than turnover of genotypes or species, 
environmental conditions are likely to stay within the range of historical variation, 
and the current state of the system is likely to capture the influence of unmeasured processes. As a result, 
for near-term forecasts time-series approaches may capture the key dynamics and provide accurate predictions.

In contrast, at long forecast horizons (decades to centuries),  environmental conditions that have not been 
historically observed are likely to not only occur but to persist long enough to drive significant turnover of genotypes and species 
along with changes in the flux of energy and nutrients.  At these long scales, the current state of the system may be 
little help in predicting the future state. For the century-scale forecasts often featured in biodiversity and 
species-distribution modeling, space-for-time approaches may effectively capture the response of ecosystems to major shifts 
in climate over long periods, producing better long-term forecasts than time-series approaches. 
Using different modeling approaches for different forecast horizons is common in other disciplines.
For example, meteorological models for short-term weather forecasts differ substantially in spatial
and temporal resolution and extent from the global circulation models used to predict long-term changes
in climate [IS THIS REALLY TRUE? REFERENCE?].

Here we use simulation models to 1) demonstrate that the best model-building approaches for ecological forecasting 
depend on the time horizon of the forecast, and 2) explore how time-series and space-for-time approaches might be 
combined to make better forecasts at intermediate time scales. We conduct two simulation case studies, one 
focused on how interspecific interactions affect the population dynamics of a focal species, and the second focused on
an eco-evolutionary scenario. Our analyses show that: 
\begin{enumerate}
	\item For short-term forecasts, phenomenological time-series approaches are hard to beat, whereas longer-term forecasts require understanding slow processes such as evolutionary and ecological selection as well as dispersal.
	\item Different kinds of data reflect the operation of different processes: longitudinal data capture autocorrelation and responses of current assemblages, while data spanning spatial gradients capture the long-term outcome of selection and dispersal.  Whether predictive models should be trained using longitudinal or spatial data sets, or both, depends on the time-scale of the desired forecast.
	\item A key challenge for future research is determining the rate at which slow processes first influence and ultimately dominate dynamics.
\end{enumerate}

\section*{Modeling approach}

In two case studies, we simulate the effects of an increase in temperature on simple systems with known dynamics.
The ``truth'' is represented by a model that is mechanistic for at least one important process, but we treat the model as unknown when
analyzing the data and we assume that perfectly recovering this model would not be possible in practice. We begin each simulation
under stationary temperature, allowing the system to equilibrate; we call this the baseline phase. 
We then increase temperature progressively over a period of time, followed by a second period of stationary, now elevated, temperature. 
The objective is to forecast the response of the system to the temperature increase based on data gathered during the baseline period. 

We make forecasts based on two phenomenological models, each representing processes operating at different time scales. 
The first phenomenological model represents the space-for-time substiution approach, which we call the ``spatial approach'' for brevity. 
We correlate the mean environment with the mean of an ecological state or rate across many sites. 
This is the approach commonly used to predict population distribution or abundance as a function of climate \citep{elith_species_2009} 
or primary production as a function of mean precipitation \citep{Sala1988}. The approach is attractive because it addresses broad spatial scales relevant to  management, and because the necessary data are widely available and the statistical analyses straightforward. The approach also has well-known weaknesses. Criticism often focuses on the assumption that current spatial patterns are in equilibrium with climate (refs?). Another issue is that these models are not dynamic;  they provide no information about how quickly the system will move from the current state to the predicted, future state. Because the patterns in the data have developed  over long time spans, they may not provide good information about dynamic changes on the order of a few years. Moreover, transient dynamics could prevent the system from ever reaching the predicted steady state \citep{Urban2012}. 

The second model represents the time-series or ``temporal approach.'' We correlate interannual variation in an ecological response with interannual variation in the environment at just one site. This approach is often used to study population or vital rate fluctuations as a function of weather \citep{dalgleish_climate_2011}, or primary production as a function of precipitation \citep{lauenroth_long-term_1992}. The advantages of this approach include its focus on temporal dynamics, meaning it can predict rates of change, and validation of the resulting near-term predictions are straightforward. However, models built using this approach typically cover a limited spatial extent (but see \citealt{kleinhesselink_response_2018}, others), and ignore slower processes, such as evolutionary adaptation or turnover in community composition, that could alter the underlying process at longer time scales \citep{clark_ecological_2001}.

We compare forecasts from both models to the simulated dynamics to determine how well the two approaches perform at different forecast horizons. We also assess the potential for combining the information available in both spatial and temporal patterns by using a weighted average of the forecasts from the spatial and temporal approaches optimized to best match the (simulated) observations. We then study how the optimal model weights change over time. We expect the temporal model to best predict short-term dynamics, the spatial model to best predict long-term dynamics, and that a combination of the two approaches will provide the best forecasts at transitional intermediate time scales.

\subsection*{Community turnover example}

Conservation biologists and natural resource managers often need to anticipate the impact of environmental change on the abundance of 
endangered species, biological invaders, and harvested species. Although the managers may be primarily interested in just the focal species, skillful prediction might require considering interactions with many other species, greatly complicating the problem. But at what forecast horizon do altered species interactions become impossible to ignore? We explored this question using a metacommunity model developed by \cite{alexander_lags_2018}. The model describes Lotka-Volterra competitive interactions among plants within sites that are arrayed along an elevation and temperature gradient. Composition varies along the gradient because of a trade-off between growth rate and cold tolerance: cold sites are dominated by slow-growing species that can tolerate low temperatures, while warm sites are dominated by  fast-growing species that are cold intolerant. Multiple species can coexist within sites because all species experience stronger competition from conspecifics than from heterospecifics. Sites are linked by dispersal: a specified fraction of each species' offspring leaves the site where they were produced and reaches all other sites with equal probability.

We first simulated a baseline period with variable but stationary temperature, followed by a period of rapid temperature increase, and then a final period of stationary temperature. Interannual variation in temperature is the same at all sites, but mean temperature varies among sites. All sites experienced the same absolute increase in mean temperature. We focused on the biomass dynamics of one focal species that dominated the central site during the baseline period.

During the baseline period there were strong spatial patterns across the mean temperature gradient. 
Individual species, including our focal species, showed classic, unimodal ``Whittaker" patterns of abundances across the gradient (Fig. \ref{fig:species-patterns-models}A).
These spatial patterns are the basis for our ``spatial model" of the temperature-biomass relationship for our focal species (Fig. \ref{fig:species-patterns-models}A). 
In contrast to the strong spatial patterns, population and community responses to interannual variation in temperature within sites were weak.
At our focal site in the center of the gradient, the biomass of the focal species was quite insensitive to interannnual variation in temperature (Fig. \ref{fig:species-patterns-models}B). Our ``temporal model" estimates this weak, linear temperature effect, along with strong lag effects of biomass in the previous year. The spatial and temporal statistical
models are described in Appendix \ref{models}.

\begin{figure}[tbp]
\centering
\includegraphics[width=1 \textwidth] {species_patterns_models.png}
\caption{(A) Mean biomass by species (colors) across the temperature gradient during the baseline period. The focal species, dominant at the site in the center of the gradient (vertical gray line), is shown in dark blue. The dashed blue line shows predictions from the spatial model. (B) Annual biomass of the focal species at the central site during the baseline period. The dashed line shows predictions from the temporal model. }
\label{fig:species-patterns-models}
\end{figure}

We forecast the effect of a temperature increase on the focal species' biomass at one location in the center of the temperature gradient 
using both spatial models and the temporal models. 
The predictions from the spatial and temporal models contrasted markedly, with the temporal 
model predicting a large increase in biomass and the spatial model predicting a decrease. Initially, the simulated abundances followed the increase predicted by the 
temporal model, but as faster-growing species colonized and increased in abundance at the focal site, the biomass of the focal species decreased, eventually falling below its baseline level (Fig. \ref{fig:community-forecast-species}). 

To combine the spatial and temporal model into a single forecast, we fit a weighting parameter, $\omega$, which varies over time and is bounded between 0 and 1. At any time point, $t$, the combined population forecast is $\omega * T(N_{t-1},K_t) + (1-\omega) * S(K_t) $ where $T$ is the temporal model, which depends on population size, $N$ and expected temperature, $K$, and $S$ is the spatial model, which depends only on $K$ (see Appendix \ref{models} for full description of the approach).
This combined model accurately predicts the simulated dynamics across the full forecast horizon (Fig. \ref{fig:community-forecast-species}), but 
the reason it works so well is that the weights were determined by fitting directly to the data. Unlike our spatial and temporal model forecasts, 
we did not generate out-of-sample predictions from the combined model; it merely provides 
a convenient way to quantify how rapidly dynamics shift from being dominated by interannual 
variation captured in the temporal model to being dominated by the steady-state equilibrium captured by the spatial model.
A true, combined forecast would require a method to determine the model weights \emph{a priori}.
The most rapid shifts in the model weights occurred during the period when warm-adapted, faster growing species were increasing most rapidly
in abundance (Fig. \ref{fig:community-weights-spp}).

\begin{figure}[tbp]
\centering
\includegraphics[width=0.7 \textwidth] {community_forecast_species.png}
\caption{(Top) Simulated annual temperatures (grey) and expected temperature (black), which was used to make forecasts, at the focal site. (Bottom) Simulated focal species biomass and forecasts from the spatial, temporal and combined models. }
\label{fig:community-forecast-species}
\end{figure}

\begin{figure}[tbp]
\centering
\includegraphics[width=0.7 \textwidth] {community_change_plus_weights_spp.png}
\caption{Simulated changes in biomass of the focal species (black) and all other species (grey) at the focal site in the metacommunity model, and the weight given to the temporal model for focal species biomass (blue). Year 0 in this figure corresponds to the start of the temperature increase. }
\label{fig:community-weights-spp}
\end{figure}

The compositional turnover affecting our focal species also influences total biomass, linking community and ecosystem dynamics. We repeated our focal species analysis 
for total community biomass, and the results were similar: the temporal model initially made the best forecasts immediately following the onset of the temperature
increase, but as the identify and abundances of species at the study site changed, the model weights rapidly shifted to the spatial model (Figs. \ref{fig:community-models-total} to \ref{fig:community-weights-total}). 

\section*{Eco-evolutionary example}

Evolutionary adaptation is a key uncertainty in predicting how environmental change will impact a focal population at a given location (refs). Like the shifts
in species composition illustrated in the previous example, shifts in genotype frequencies can also influence dynamics and forecasts at different time scales.
We demonstrate this process with a hypothetical annual plant population in which fecundity is temperature dependent, and different genotypes have different temperature optima (Fig. \ref{fig:evo_evo_spatial_temporal_models}A). The full model description is provided in Appendix \ref{eco-evo}. Genotype frequencies will shift across a gradient of mean annual temperature: cold sites will be dominated by the cold-adapted homozygous genotype, warm sites will be dominated by the heat-adapted homozygous genotype, and intermediate sites will be dominated by the heterozygous genotype (Fig. \ref{fig:evo_evo_spatial_temporal_models}B).

\begin{figure}[tbp]
\centering
\includegraphics[width=0.4 \textwidth]{spatial&temporal_model.png}
\caption{(A) Reaction norms of the three genotypes. (B) The spatial pattern of individual genotypes (colors) and total population abundance (black) at sites arrayed across a gradient of mean annual temperature. The dashed line shows predictions from an empirical ``spatial model," a linear regression that describes mean population size as a function of mean temperature. (C) The relationship between annual temperature and per capita growth rate at a location with a mean temperature that favors the cold-adapted genotype. Colors show population size (the blue to red gradient depicting low to high population density), which influences the population growth rate through density dependence. }
\label{fig:evo_evo_spatial_temporal_models}
\end{figure}

The spatial pattern shown in Fig. \ref{fig:evo_evo_spatial_temporal_models}B is the outcome of steady-state conditions. But at any one site, the population's short-term response to temperature will be determined by the dominant genotype's reaction norm. For example, at a cold site dominated by the cold-adapted homozygous genotype, a warmer than average year would cause a decrease in population size, even though the heat-adapted homozygote might perform optimally at that temperature. However, if warmer than normal conditions persist for many years, then genotype frequencies should shift, and the heat-adapted homozygote will compensate for the decreases of the cold-adapted genotype. 

To demonstrate these dynamics, we simulated a diploid annual plant population at a colder than average site. During the baseline period, the population is dominated by the cold-adapted genotype. We used the simulated data from this baseline period to fit an empirical model that assumes no knowledge of the underlying eco-evolutionary process. This empirical temporal model (Appendix \ref{models}) predicts population growth rate as a function of annual temperature and population size (Fig. \ref{fig:evo_evo_spatial_temporal_models}C). We then imposed a period of warming, followed by a final period of higher stationary temperature (Fig. \ref{fig:forecast} top).

With the onset of warming, the population crashed as the cold-adapted genotype decreased in abundance. Eventually, frequencies of the heterozygous genotype and the warm-adapted homozygous genotype began to increase and the population recovered (Fig. \ref{fig:forecast} bottom). The temporal model accurately predicted the impact of the initial warming trend, but eventually became too pessimistic, while the spatial model did not handle the initial trend but accurately predicted the eventual, new steady state (Fig. \ref{fig:forecast} bottom).

As in the community turnover example, we also fit a combined model as a weighted average of the spatial and temporal model, with the weights changing over time. The combined model initially reflected the temporal model, but then rapidly transitioned to reflect the spatial model. The rapid transition in the weighting term, $\omega$, occurred during the period of most rapid change in genotype frequencies (Fig. \ref{fig:forecast_supp}). The combined model's predictions look impressively accurate, but, as in the community turnover example, that is because we used the full, simulated time series to fit the weighting term. To generate a true forecast from the combined model, we would need an independent method to predict how the model weights shift over time.

\begin{figure}[tbp]
\centering
\includegraphics[width=0.7 \textwidth] {forecast.png}
\caption{(Top) Simulated annual temperatures (grey) and expected temperature (black), which was used to make forecasts. (Bottom) Simulated population size and forecasts from the spatial, temporal and combined models.  }
\label{fig:forecast}
\end{figure}

\subsection*{Discussion}

Ecological forecasts are typically made using models fit to either time-series data or spatial data based on the concept of space-for-time substitutions.
Our results demonstrate that forecasts based on these two approaches can lead to very different predictions for the future state of ecological systems.
Which approach provides the most accurate forecasts depends on the time-horizon, or how far into the future we are attempting to forecast.
For short-term forecasts, time-series approaches perform best, whereas longer-term forecasts are more accurately made using models from spatial data.
This stems from differences between data types in the types and scales of processes they capture.
Local time-series data capture demographic processes, autocorrelation (including lagged responses) and responses of current assemblages to small changes
in environmental conditions. In addition, the state of the system a short period into the future depends heavily on the current state (i.e., the initial
condition). Since short-term forecasts do not typically require extrapolating into novel conditions; the historical range of variation, incorporating lags
and accurate initial conditions present in local time-series data is likely to be the most generally useful approach for forecasting.
In contrast, data spanning spatial gradients captures the long-term outcome of slower processes including selection, dispersal, and responses to large
changes in the environment. This makes models based on these data more likely to accurately predict long-term steady state outcomes of ecological change.

These results suggest that near-term forecasts will likely be most effective when made using time-series models, a result backed by recent empirical
analyses of biodiversity forecasts at time scales from one to ten years (Harris et al. 2018). For long-term forecasts our results suggest the use
of models built on spatial data. However, determining what is "near-term" and what is "long-term" in this context is an open question, and
many important forecasts in ecology will be needed at intermediate time horizons where neither approach will be
fully sufficient. Our simulation results demonstrate that there are often extended transitional period where neither approach is effective on its own,
but where a weighted combination of time-series and spatial models can produce highly accurate predictions. Unfortunately there is no clear
way to determine how to weight these two approaches for different time horizons. Our combined ``forecasts'' used the performance of
the forecasts on simulated data to select the weights. This approach cannot be used for actual forecasting because it is effectively an empirical
quantification of the observed performance of the forecasts at different time horizons. Determining how to set these
weights a priori could be pursued using both theoretical and empirical approaches. On the theoretical side, it should be possible to explore the influence
of different parameters on how quickly slow processes (represented in spatial data) begin to influence dynamics. The effects of some parameters are intuitive:
in the community turnover example, increasing the fraction of dispersing individuals causes a more rapid shift in species composition and in model weights
(Fig. \ref{fig:dispersal_niche_width}A). Other factors to consider include organism lifespans, niche widths, and the magnitude of directional environmental
change relative to interannual variation. From an empirical perspective, this challenge could be addressed by using synthetic analyses to estimate the
weighting function. By evaluating both time-series and spatial models for large numbers of forecasts across a range of time-horizons it should be possible
to develop rules of thumb for ensembling models encompassing different scales of processes. This requires data sets that can support the evaluation of
long-term forecasts, which could include paleoecological data (e.g.,), long-term historical data sets (e.g., ), and the use of model systems with
short-generation times (e.g., Petchy), With enough case studies, we might be able to infer patterns that could guide applications in new systems.

\begin{figure}[tbp]
	\centering
	\includegraphics[width=0.7 \textwidth] {dispersal_niche_width.png}
	\caption{(The rate of change in the weight of the temporal forecast (y-axis) depends on (A) the fraction of propagules dispersing in the community turnover example and (B) on the temperature tolerance of genotypes, given by $\sigma_T$ (larger values indicate wider thermal niches) in the eco-evolutionary example. Year 0 in these figures corresponds to the start of the temperature increase. }
	\label{fig:dispersal_niche_width}
\end{figure}

Instead of trying to weight distinct approaches an alternative approach is to build fully process based models of ecological systems  for forecasting.
If it is possible to accurately characterize all of the processes governing a system then a model based on that understanding should make accurate
predictions at all time-horizons. For example, if we had evaluated the exact process-based models that we used to generate the simulated time series,
these models would have been able to accurately capture the full dynamics and forecasts for all time horizons. In concept, process based models should
also be more robust for making predictions outside of historically observed conditions (or beyond the conditions observed across spatial gradients).
This is particularly important for making predictions in a future that is predicted to be increasingly "non-analog", where combinations of environment
and species interactions exist that have never occurred before (Williams et al.) Unfortunately, this approach is not currently feasible in most cases,
because we lack a detailed knowledge of all of the complex and interacting processes influencing the dynamics of real ecological systems. Even if the
general form of the models was understood estimating the high number of parameters and quantifying how they vary across
ecosystems typically require more data than is currently available for even well studied systems. As a result, models used for ecological forecasting
will include at least some phenomenological components. But that does not mean that these forecasts do not rely on process-based understanding in some way.
The message from our simulations is that different processes should be considered for different forecast time-scales, and this can be done by fitting
models to different kinds of data sets. Even when process-level understanding does not enable a fully mechanistic model, it can improve the specification
of phenomenological models.

Another approach to addressing the joint importance of spatial and time-series data for making ecological forecasts is joint spatiotemporal modeling...

These results have important implications for the emerging field of ecological forecasting. They suggest that evaluating both near-term and long-term
forecasts is essential to fully understanding the best methods for forecasting and how well they perform. Our results further suggest that while
single approaches may perform reasonably well at short and long time horizons, that intermediate time horizons may require a combination of information
from spatial and temporal patterns. Related challenges with intermediate time horizons occur in other forecasting contexts. Weather forecasts based one
type of models are very effective for forecasting a week to ten days in advance, but then become largely uninformative. Climate models provide accurate
predictions for similar variables, but generally at decadal time-scales. Forecasting in between these two time scales has been challenging in meteorology
and will likely be challenging in ecology as well. In combination that means that while the recent emphasis on near-term iterative forecasting (Dietze 
et al. 2018), is important, we also need to build understanding and capacity for mkaing forecasts across the full range of scales of interest in
ecology, from hours to decades. 

\newpage
\renewcommand{\refname}{Literature cited}
\bibliographystyle{Ecology}
\bibliography{references}


%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
% APPENDICES !
%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

\clearpage 
\newpage 

\setcounter{page}{1}
\setcounter{equation}{0}
\setcounter{figure}{0}
\setcounter{section}{0}
\setcounter{table}{0}

\centerline{\Large \textbf{Appendices}}

\renewcommand{\thesection}{\Alph{section}}

\section{Spatial, temporal and combined models}\label{models}

The spatial model, which we refer to as $S$, is a linear regression fit to ``observed" data on mean population size, $\bar{N}$ at a series of locations, $x$, which vary in mean temperature, $K$. In our case, the observed data are simulated by the model described in the previous section. For both examples in the main text, we include a quadratic term to capture the unimodal relationship between  $\bar{N}$ and $K$:
 \begin{equation}
 \bar{N}_x = S(K_x) = \beta^S_0 +  \beta^S_1 K_x +\beta^S_2 {K_x}^2 + \varepsilon
 \label{eqn:spatial_regression}
 \end{equation}
For the total biomass example from the community turnover model (results in Appendix \ref{biomass}), we dropped the quadratic term.

The temporal model, which we call $T$, starts with a time series of ``observed" population sizes, or total biomasses, $\vec{N}$ at one location. In the community turnover example, we use data from a baseline period with a stationary distribution of annual temperature at the focal location, we fit the following regression, which predicts biomass at time $t+1$ as a function of biomass and annual temperature at time $t$:
 \begin{equation}
 \ln(N_{t+1}) = T(N_t,K_t) = \beta^T_0 +  \beta^T_1 ln(N_t) +\beta^T_2 K_t  +  \varepsilon
 \label{eqn:temporal_regression_community}
 \end{equation}
 For the eco-evolutionary example, the response variable is the log of the population growth rate, and we include a quadratic effect of annual temperature:
  \begin{equation}
  \ln(\frac{N_{t+1}}{N_t}) = T(N_t,K_t) = \beta^T_0 +  \beta^T_1 ln(N_t) +\beta^T_2 K_t  +\beta^T_3 K_t^2 +  \varepsilon
  \label{eqn:temporal_regression_ecoevo}
  \end{equation}
 This version of the temporal model returns a per capita growth rate on the log scale. To predict population size at the next time step, we simply exponentiate the growth rate and multiply it by the current population size: $exp(T(N_t,K_t)) N_t$.

The combined model is a weighted average of predictions from the spatial and temporal models, with the weights changing as a function of time, here expressed as the forecast horizon. The weights change as a function of the square root of the forecast horizon, to allow rapid shifts in the model weights. 
\begin{equation}
logit(\omega_t)=\beta^C_0 + \beta^C_1 \sqrt{t}
\label{eqn:weights}
\end{equation}
For the community turnover example, the predicted biomass from the combined model is:
\begin{equation}
\hat{N}_{t+1} = \omega *T(N_{t},K_t) + (1-\omega) * S(K_t) 
\label{eqn:combined_model}
\end{equation}
For the eco-evolutionary example, the predicted population size from the combined model is:
\begin{equation}
\hat{N}_{t+1} = \omega * exp(T(N_{t},K_t)) N_t + (1-\omega) * S(K_t) 
\label{eqn:combined_model}
\end{equation}

We used the \texttt{optim} function to estimate the $\beta^C$s that minimize the sum of squared errors, $(\hat{N}_{t+1} - N_{t+1})^2$

\section{Description of the eco-evolutionary annual plant model}\label{eco-evo}

\renewcommand{\theequation}{B-\arabic{equation}}
\renewcommand{\thetable}{B-\arabic{table}}
\renewcommand{\thefigure}{B-\arabic{figure}}

\noindent \textbf{Haploid Model:} Begin with a haploid model that describes the number of seeds present in a seed bank.  $N_{i,t}$ is the number of seeds of species $i$ at time $t$.  The model is
\begin{align}\begin{split}
N_{1,t+1} &= s_1 [1-g_1(E_t)]N_{1,t}+\frac{\lambda_1g_1(E_t)N_{1,t}}{1+ \alpha_{11}g_1(E_t)N_{1,t} + \alpha_{12}g_2(E_t)N_{2,t}}\\
N_{2,t+1} &= s_2 [1-g_2(E_t)]N_{2,t}+\frac{\lambda_2g_2(E_t)N_{2,t}}{1+ \alpha_{21}g_1(E_t)N_{1,t} + \alpha_{22}g_2(E_t)N_{2,t}}
\end{split}\end{align}
where $g_{i}(E_t)$ is the probability of germination, $E_t$ is the environmental quality at time $t$, $s_i$ is the seed survival probability for species $i$, and $\lambda_i$ is the seed production rate per plant.  Below I refer to the $\alpha_{ij}$ as intra- and inter-specific competition coefficients.  \\

\noindent \textbf{Diploid Model:} Consider a one-species diploid model.  The genotypes are denoted by $AA$, $Aa$, and $aa$.   The number of each genotypes at time $t$ is $N_{AA,t}$, $N_{Aa,t}$, and $N_{aa,t}$.  The germination rates for each genotype are $g_{AA}(E_t)$, $g_{Aa}(E_t)$, and $g_{aa}(E_t)$.  The seed survival probability and seed production rate for genotype $AA$ are $s_{AA}$ and $\lambda_{AA}$, respectively.  The analogous parameters for the other genotypes are similarly denoted.  The competition coefficients are denoted by $\alpha_{i,j}$, e.g., $\alpha_{AA,AA}$ or $\alpha_{AA,Aa}$.  Throughout we assume that gametes mix randomly in the population.  

First consider the case where the competition coefficients are zero ($\alpha_{i,j}=0$).  Let $T$ denote the total number of gamete-pairs produced in a given year,
\begin{equation}
T = \lambda_{AA}N_{AA,t}g_{AA}(E_t)+ \lambda_{Aa}N_{Aa,t}g_{Aa}(E_t)+\lambda_{aa}N_{aa,t}g_{aa}(E_t).
\end{equation}
The first term is the number of gamete-pairs produced by $AA$ individuals.  The second and third terms are the numbers of gamete-pairs produced by $Aa$ and $aa$ individuals, respectively. The proportion of $A$ gametes ($\phi_A$) and the proportion of $a$ gametes ($\phi_a$) are given by
\begin{align}\begin{split}
\phi_{A} &= \frac{\lambda_{AA}N_{AA,t}g_{AA}(E_t)+ \frac{1}{2}\lambda_{Aa}N_{Aa,t}g_{Aa}(E_t)}{T} \hspace{10pt} \text{and} \hspace{10pt} \phi_a = 1-\phi_{A}.
\end{split}\end{align}
Note that the $T$ in the denominator of $\phi_A$ shows up because we are computing proportions.  Combining all of these we get the dynamics for each genotype,
\begin{align}\begin{split}
N_{AA,t+1} &= s_{AA}[1-g_{AA}(E_t)]N_{AA,t} + \phi_A^2T\\
N_{Aa,t+1} &= s_{Aa}[1-g_{Aa}(E_t)]N_{Aa,t} + \phi_A\phi_aT\\
N_{aa,t+1} &= s_{aa}[1-g_{aa}(E_t)]N_{aa,t} + \phi_a^2T
\end{split}\end{align}

Now consider the case where the competition coefficients are non-zero ($\alpha_{i,j}\neq0$).  Including competition changes the way in which we compute $T$, $\phi_A$, and $\phi_a$.  Specifically, because the total number of seeds produced per year by each genotypes is reduced based on intra- and inter-specific competition, the total number of gamete-pairs becomes
\begin{align}\begin{split}
T &=  \frac{\lambda_{AA}N_{AA,t}g_{AA}(E_t)}{1+ \alpha_{AA,AA}g_{AA}(E_t)N_{AA,t} + \alpha_{AA,Aa}g_{Aa}(E_t)N_{Aa,t}+ \alpha_{AA,aa}g_{aa}(E_t)N_{aa,t}} \\ 
&+ \frac{\lambda_{Aa}N_{Aa,t}g_{Aa}(E_t)}{1+ \alpha_{Aa,AA}g_{AA}(E_t)N_{AA,t} + \alpha_{Aa,Aa}g_{Aa}(E_t)N_{Aa,t}+ \alpha_{Aa,aa}g_{aa}(E_t)N_{aa,t}}\\
&+\frac{\lambda_{aa}N_{aa,t}g_{aa}(E_t)}{1+ \alpha_{aa,AA}g_{AA}(E_t)N_{AA,t} + \alpha_{aa,Aa}g_{Aa}(E_t)N_{Aa,t}+ \alpha_{aa,aa}g_{aa}(E_t)N_{aa,t}}.
\label{eqn:defineT}
\end{split}\end{align}
The first line is the number of gamete-pairs produced by $AA$ individuals after accounting for the effects of competition.  The second and third lines are the numbers of gamete-pairs produced by $Aa$ and $aa$ individuals, respectively. The proportions of $A$ gametes and $a$ gametes are 
\begin{align}\begin{split}
\phi_A &= \frac{1}{T}\frac{\lambda_{AA}N_{AA,t}g_{AA}(E_t)}{1+ \alpha_{AA,AA}g_{AA}(E_t)N_{AA,t} + \alpha_{AA,Aa}g_{Aa}(E_t)N_{Aa,t}+ \alpha_{AA,aa}g_{aa}(E_t)N_{aa,t}} \\
&+ \frac{1}{2T}\frac{\lambda_{Aa}N_{Aa,t}g_{Aa}(E_t)}{1+ \alpha_{Aa,AA}g_{AA}(E_t)N_{AA,t} + \alpha_{Aa,Aa}g_{Aa}(E_t)N_{Aa,t}+ \alpha_{Aa,aa}g_{aa}(E_t)N_{aa,t}}\\
\phi_a &= 1- \phi_A
\label{eqn:definePhi}
\end{split}\end{align}
Combining all of this results in the same model as above,
\begin{align}\begin{split}
N_{AA,t+1} &= s_{AA}[1-g_{AA}(E_t)]N_{AA,t} + \phi_A^2T\\
N_{Aa,t+1} &= s_{Aa}[1-g_{Aa}(E_t)]N_{Aa,t} + 2 \phi_A\phi_aT\\
N_{aa,t+1} &= s_{aa}[1-g_{aa}(E_t)]N_{aa,t} + \phi_a^2T,
\end{split}\end{align}
but the definitions of $T$, $\phi_A$, and $\phi_a$ are given by equations (\ref{eqn:defineT}) and (\ref{eqn:definePhi}) . 

\section{Supplementary Figures}

\renewcommand{\thefigure}{C-\arabic{figure}}

\begin{figure}[tbp]
\centering
\includegraphics[width=0.7 \textwidth] {community_models_total.png}
\caption{(Results for total biomass from the community turnover model. Blue points show mean total biomass during the baseline period at locations across the temperature gradient, and the blue line shows predictions from the spatial model. Red points show annual total biomass during the baseline period as a function of annual temperature at the central site on the gradient. The red line shows predictions from the temporal model.   }
\label{fig:community-models-total}
\end{figure}

\begin{figure}[tbp]
\centering
\includegraphics[width=0.7 \textwidth] {community_forecast_total.png}
\caption{Results for total biomass from the community turnover model. (Top) Simulated annual temperatures (grey) and expected temperature (black), which was used to make forecasts, at the focal site. (Bottom) Simulated total biomass and forecasts from the spatial, temporal and combined models.  }
\label{fig:community-forecasts-total}
\end{figure}

\begin{figure}[tbp]
\centering
\includegraphics[width=0.7 \textwidth] {community_change_plus_weights_total.png}
\caption{Simulated changes in biomass of all species (grey) at the focal site in the metacommunity model, and the weight given to the temporal model for total biomass (blue). Year 0 in this figure corresponds to the start of the temperature increase. }
\label{fig:community-weights-total}
\end{figure}

\begin{figure}[tbp]
\centering
\includegraphics[width=0.7 \textwidth] {forecast_supplement.png}
\caption{Simulated shifts in genotype abundances, and the model weighting term, $\omega$, during the warming phase and the following stationary temperature phase. Year 0 in this figure corresponds to the start of the temperature increase.}
\label{fig:forecast_supp}
\end{figure}


\end{document}

