%---------------------------------------------
% This document is for pdflatex
%---------------------------------------------
\documentclass[11pt]{article}

\usepackage{amsmath,amsfonts,amssymb,graphicx,setspace,authblk}
\usepackage{float}
\usepackage[running]{lineno}
\usepackage[vmargin=1in,hmargin=1in]{geometry}

\usepackage[authoryear]{natbib}

\graphicspath{ {./../genetic-diversity/figures/} }

\usepackage{enumitem}
\setlist{topsep=.125em,itemsep=-0.15em,leftmargin=0.75cm}

\usepackage{gensymb}

\usepackage[compact]{titlesec} 

\usepackage{bm,mathrsfs}

\usepackage{ifpdf}
\ifpdf
\DeclareGraphicsExtensions{.pdf,.png,.jpg}
\usepackage{epstopdf}
\else
\DeclareGraphicsExtensions{.eps}
\fi

\renewcommand{\floatpagefraction}{0.98}
\renewcommand{\topfraction}{0.99}
\renewcommand{\textfraction}{0.05}

\clubpenalty = 10000
\widowpenalty = 10000

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
%%% Just for commenting
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\usepackage[usenames]{color}
\newcommand{\new}{\textcolor{red}}
\newcommand{\spe}{\textcolor{blue}}
\newcommand{\comment}{\textcolor{black}}

\newcommand{\be}{\begin{equation}}
\newcommand{\ee}{\end{equation}}
\newcommand{\ba}{\begin{equation} \begin{aligned}}
\newcommand{\ea}{\end{aligned} \end{equation}}

\def\X{\mathbf{X}}

\floatstyle{boxed}
\newfloat{Box}{tbph}{box}

\title{Integrating spatial and temporal patterns in ecological forecasts }

\author[1]{Peter B. Adler}  %\thanks{Corresponding author. Department of Wildland Resources and the Ecology Center, Utah State University, Logan, Utah Email: peter.adler@usu.edu}}
\author[2]{Ethan White}
\author[3]{Michael Cortez?}
\author[4]{others?}
\affil[1]{Department of Wildland Resources and the Ecology Center, Utah State University, Logan, Utah}
\affil[2]{some shitty Florida joint}


\renewcommand\Authands{ and }

% \date{Last compile: \today} 

\sloppy

\renewcommand{\baselinestretch}{1.25}

\begin{document}

\maketitle

\linenumbers

\section*{Abstract}

stuff

%\textbf{\large{Keywords:}} Coexistence, competition, integral projection model, removal experiment, sagebrush steppe. 

\section*{Introduction}

We love ecological forecasting yada yada. Common approaches use spatial patterns, temporal patterns, and process-level understanding (i.e., mechanistic models). Since we will never know all the mechanisms, we will inevitably need to rely on patterns. But they have limitations.

The spatial approach: Correlate mean environment with the mean of an ecological state variable or rate across many sites. Examples: population distribution or abundance as a function of climate (SDM refs), primary production as a function of mean precipitation (Lauenroth refs).  Strengths: broad spatial scales, data are available and analyses are straightforward. Weaknesses: many well-recognized issues involving assumptions. A less well-recognized issue is that these models are not dynamic; they provide no information about how quickly the system will move from the current state to the predicted, future state. These patterns have developed over very long time spans, so they are unlikely to provide much information about dynamic changes on the order of years to decades. In addition, transient dynamics could prevent the system from ever reaching the predicted steady state (Urban ref?). 

The temporal approach: Correlate interannual variation in an ecological response with interannual variation in the environment, typically at just one site (but see Kleinhesselink  and Adler 2018, others). Examples: population or vtial rate fluctuations as a function of weather, primary production as a function of precipitation (Lauenroth and Sala 1992). Strengths: focuses on temporal dynamics, can predict rates of change, easily validated. Weaknesses: typically limited spatial extent, ignores slower processes, such as evolutionary adaptation, or turnover in community composition, that could alter the underlying process at longer time scales.

Our goal is to capitalize on the complementary strengths of the spatial and temporal approaches. The idea is to take predictions from a spatial and a temporal model and combine them with a weighted average. The model weights can change over time: we expect the temporal model to dominate in the short-term, and the spatial model to dominate in the long-term. How rapidly that transition occurs depends on the rate of those ``slow" processes such as evolution and species turnover. We might learn something interesting by studying the rate at which the model weights change.

\section*{Eco-evo example}

Consider a hypothetical annual plant population in which fecundity is temperature dependent, and different genotypes have different temperature optima (Fig. \ref{fig:spatial_model}A; the full model description is provided in the Appendix, and all computer code is available on Github: \texttt{https://github.com/pbadler/space-time-forecast}). Genotype frequencies will shift across a gradient of mean annual temperature: cold sites will be dominated by the cold-adapted homozygous genotype, warm sites will be dominated by the heat-adapted homozygous genotype, and intermediate sites will be dominated by the heterozygous genotype (Fig. \ref{fig:spatial_model}B).

\begin{figure}[tbp]
\centering
\includegraphics[width=1 \textwidth]{spatial_model.png}
\caption{(A) Reaction norms of the three genotypes. (B) The spatial pattern of individual genotypes and total population abundances at sites arrayed across a gradient of mean annual temperature. The dashed line shows predictions from an empirical ``spatial model," a linear regression that describes mean population size as a function of mean temperature. }
\label{fig:spatial_model}
\end{figure}

This spatial pattern is the outcome of steady-state conditions. But at any one site, the population's short-term response to temperature will be determined by the dominant genotype's reaction norm. For example, at a cold site dominated by the cold-adapted homozygous genotype, a warmer than average year would cause a decrease in population size, even though the heat-adapted homozygote might perform optimally at that same temperature. However, if warmer than normal conditions persist for many years, then genotype frequencies should shift, and the heat-adapted homozygote will compensate for the decreases of the cold-adapted genotype. 

To demonstrate these dynamics, we simulated a diploid annual plant population at a colder than average site. During the baseline period, the population is dominated by the cold-adapted genotype. We use the simulated data from this baseline period to fit an empirical model that assume no knowledge of the true underlying process. This empirical ``temporal model" predicts population growth rate as a function of annual temperature and population size (Fig. \ref{fig:temporal_model}). We then imposed a period of warming, followed by a final period of higher, but stationary, temperature (Fig. \ref{fig:forecast} top). With the onset of warming, the population crashes as the cold-adapted genotype decreases in abundance. Eventually, frequencies of the heterozygous genotype and the warm-adapted homozygous genotype begin to increases and the population recovers (Fig. \ref{fig:forecast} bottom). 

\begin{figure}[tbp]
\centering
\includegraphics[width=0.6 \textwidth] {temporal_model.png}
\caption{The relationship between annual temperature and per capita growth rate at a location with a mean temperature that favors the cold-adapted genotype. Colors show population size, which also influences the population growth rate through density dependence.  }
\label{fig:temporal_model}
\end{figure}

The implications for forecasting are clear: In the initial stages of the warming trend, the temporal model fit to the original, baseline conditions should make better the best predictions about resulting population trends, but in the longer term, as evolutionary change occurs, the spatial model will begin to make better predictions. 
To combine the spatial and temporal model into a single forecast, we fit a weighting parameter, $\omega$, which varies over time and is bounded between 0 and 1. At any time point, $t$, the combined population forecast is $\omega * T(N_{t-1},K_t) + (1-\omega) * S(K_t) $ where $T$ is the temporal model, which depends on population size, $N$ and expected temperature, $K$, and $S$ is the spatial model, which depends only on $K$ (see Appendix for full description of the approach). The temporal model accurately predicts the impact of the initial warming trend, but eventually becomes far too pessimistic, while the spatial model does not handle the initial trend but accurately predicts the eventual, new steady state (Fig. \ref{fig:forecast} bottom). The combined model initially reflects the temporal model, but then rapidly transitions to reflect the spatial model. The rapid transition in the weighting term, $\omega$, occurs during the period of most rapid change in genotype frequencies (Fig. \ref{fig:forecast_supp}).

\begin{figure}[tbp]
\centering
\includegraphics[width=0.7 \textwidth] {forecast.png}
\caption{(Top) Simulated annual temperatures (grey) and expected temperature (black), which was used to make forecasts. (Bottom) Simulated population size and forecasts from the spatial, temporal and combined models.  }
\label{fig:forecast}
\end{figure}

\begin{figure}[tbp]
\centering
\includegraphics[width=0.7 \textwidth] {forecast_supplement.png}
\caption{Simulated shifts in genotype abundances, and the model weighting term, $\omega$, during the warming phase and the following stationary temperature phase.}
\label{fig:forecast_supp}
\end{figure}

Next steps? Play with parameters to show what controls the rate of transition from temporal to spatial model?

%\newpage
%\renewcommand{\refname}{Literature cited}
%\bibliographystyle{Ecology}
%\bibliography{RemovalRefs}


%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
% APPENDICES !
%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

\clearpage 
\newpage 

\setcounter{page}{1}
\setcounter{equation}{0}
\setcounter{figure}{0}
\setcounter{section}{0}
\setcounter{table}{0}

\centerline{\Large \textbf{Appendices}}

\vspace{0.4in} 

\renewcommand{\theequation}{A-\arabic{equation}}
\renewcommand{\thetable}{A-\arabic{table}}
\renewcommand{\thefigure}{A-\arabic{figure}}
\renewcommand{\thesection}{\Alph{section}}

\section*{Description of the eco-evolutionary annual plant model}

(from Michael Cortez)

\noindent \textbf{Haploid Model:} Begin with a haploid model that describes the number of seeds present in a seed bank.  $N_{i,t}$ is the number of seeds of species $i$ at time $t$.  The model is
\begin{align}\begin{split}
N_{1,t+1} &= s_1 [1-g_1(E_t)]N_{1,t}+\frac{\lambda_1g_1(E_t)N_{1,t}}{1+ \alpha_{11}g_1(E_t)N_{1,t} + \alpha_{12}g_2(E_t)N_{2,t}}\\
N_{2,t+1} &= s_2 [1-g_2(E_t)]N_{2,t}+\frac{\lambda_2g_2(E_t)N_{2,t}}{1+ \alpha_{21}g_1(E_t)N_{1,t} + \alpha_{22}g_2(E_t)N_{2,t}}
\end{split}\end{align}
where $g_{i}(E_t)$ is the probability of germination, $E_t$ is the environmental quality at time $t$, $s_i$ is the seed survival probability for species $i$, and $\lambda_i$ is the seed production rate per plant.  Below I refer to the $\alpha_{ij}$ as intra- and inter-specific competition coefficients.  \\

\noindent \textbf{Diploid Model:} Consider a one-species diploid model.  The genotypes are denoted by $AA$, $Aa$, and $aa$.   The number of each genotypes at time $t$ is $N_{AA,t}$, $N_{Aa,t}$, and $N_{aa,t}$.  The germination rates for each genotype are $g_{AA}(E_t)$, $g_{Aa}(E_t)$, and $g_{aa}(E_t)$.  The seed survival probability and seed production rate for genotype $AA$ are $s_{AA}$ and $\lambda_{AA}$, respectively.  The analogous parameters for the other genotypes are similarly denoted.  The competition coefficients are denoted by $\alpha_{i,j}$, e.g., $\alpha_{AA,AA}$ or $\alpha_{AA,Aa}$.  Throughout we assume that gametes mix randomly in the population.  

First consider the case where the competition coefficients are zero ($\alpha_{i,j}=0$).  Let $T$ denote the total number of gamete-pairs produced in a given year,
\begin{equation}
T = \lambda_{AA}N_{AA,t}g_{AA}(E_t)+ \lambda_{Aa}N_{Aa,t}g_{Aa}(E_t)+\lambda_{aa}N_{aa,t}g_{aa}(E_t).
\end{equation}
The first term is the number of gamete-pairs produced by $AA$ individuals.  The second and third terms are the numbers of gamete-pairs produced by $Aa$ and $aa$ individuals, respectively. The proportion of $A$ gametes ($\phi_A$) and the proportion of $a$ gametes ($\phi_a$) are given by
\begin{align}\begin{split}
\phi_{A} &= \frac{\lambda_{AA}N_{AA,t}g_{AA}(E_t)+ \frac{1}{2}\lambda_{Aa}N_{Aa,t}g_{Aa}(E_t)}{T} \hspace{10pt} \text{and} \hspace{10pt} \phi_a = 1-\phi_{A}.
\end{split}\end{align}
Note that the $T$ in the denominator of $\phi_A$ shows up because we are computing proportions.  Combining all of these we get the dynamics for each genotype,
\begin{align}\begin{split}
N_{AA,t+1} &= s_{AA}[1-g_{AA}(E_t)]N_{AA,t} + \phi_A^2T\\
N_{Aa,t+1} &= s_{Aa}[1-g_{Aa}(E_t)]N_{Aa,t} + \phi_A\phi_aT\\
N_{aa,t+1} &= s_{aa}[1-g_{aa}(E_t)]N_{aa,t} + \phi_a^2T
\end{split}\end{align}

Now consider the case where the competition coefficients are non-zero ($\alpha_{i,j}\neq0$).  Including competition changes the way in which we compute $T$, $\phi_A$, and $\phi_a$.  Specifically, because the total number of seeds produced per year by each genotypes is reduced based on intra- and inter-specific competition, the total number of gamete-pairs becomes
\begin{align}\begin{split}
T &=  \frac{\lambda_{AA}N_{AA,t}g_{AA}(E_t)}{1+ \alpha_{AA,AA}g_{AA}(E_t)N_{AA,t} + \alpha_{AA,Aa}g_{Aa}(E_t)N_{Aa,t}+ \alpha_{AA,aa}g_{aa}(E_t)N_{aa,t}} \\ 
&+ \frac{\lambda_{Aa}N_{Aa,t}g_{Aa}(E_t)}{1+ \alpha_{Aa,AA}g_{AA}(E_t)N_{AA,t} + \alpha_{Aa,Aa}g_{Aa}(E_t)N_{Aa,t}+ \alpha_{Aa,aa}g_{aa}(E_t)N_{aa,t}}\\
&+\frac{\lambda_{aa}N_{aa,t}g_{aa}(E_t)}{1+ \alpha_{aa,AA}g_{AA}(E_t)N_{AA,t} + \alpha_{aa,Aa}g_{Aa}(E_t)N_{Aa,t}+ \alpha_{aa,aa}g_{aa}(E_t)N_{aa,t}}.
\label{eqn:defineT}
\end{split}\end{align}
The first line is the number of gamete-pairs produced by $AA$ individuals after accounting for the effects of competition.  The second and third lines are the numbers of gamete-pairs produced by $Aa$ and $aa$ individuals, respectively. The proportions of $A$ gametes and $a$ gametes are 
\begin{align}\begin{split}
\phi_A &= \frac{1}{T}\frac{\lambda_{AA}N_{AA,t}g_{AA}(E_t)}{1+ \alpha_{AA,AA}g_{AA}(E_t)N_{AA,t} + \alpha_{AA,Aa}g_{Aa}(E_t)N_{Aa,t}+ \alpha_{AA,aa}g_{aa}(E_t)N_{aa,t}} \\
&+ \frac{1}{2T}\frac{\lambda_{Aa}N_{Aa,t}g_{Aa}(E_t)}{1+ \alpha_{Aa,AA}g_{AA}(E_t)N_{AA,t} + \alpha_{Aa,Aa}g_{Aa}(E_t)N_{Aa,t}+ \alpha_{Aa,aa}g_{aa}(E_t)N_{aa,t}}\\
\phi_a &= 1- \phi_A
\label{eqn:definePhi}
\end{split}\end{align}
Combining all of this results in the same model as above,
\begin{align}\begin{split}
N_{AA,t+1} &= s_{AA}[1-g_{AA}(E_t)]N_{AA,t} + \phi_A^2T\\
N_{Aa,t+1} &= s_{Aa}[1-g_{Aa}(E_t)]N_{Aa,t} + 2 \phi_A\phi_aT\\
N_{aa,t+1} &= s_{aa}[1-g_{aa}(E_t)]N_{aa,t} + \phi_a^2T,
\end{split}\end{align}
but the definitions of $T$, $\phi_A$, and $\phi_a$ are given by equations (\ref{eqn:defineT}) and (\ref{eqn:definePhi}) . 

\section*{Estimating model weights}

Here is my home brew approach, presented in my typically terrible notation. There must be a better, more formal approach...Help?

The spatial model, which we refer to as $S$, is a linear regression fit to ``observed" data on mean population size, $\bar{N}$ at a series of locations, $x$, which vary in mean temperature, $K$. In our case, the observed data are simulated by the model described in the previous section. We include a quadratic term to capture the unimodal relationship between  $\bar{N}$ and $K$:
 \begin{equation}
 \bar{N}_x = S(K_x) = \beta^S_0 +  \beta^S_1 K_x +\beta^S_2 {K_x}^2 + \varepsilon
 \label{eqn:spatial_regression}
 \end{equation}

The temporal model, which we call $T$, starts with a time series of ``observed" population sizes, $\vec{N}$. Using data from a baseline period with a stationary distribution of annual temperature at one location, we fit the following regression, which predicts the (log) population growth rate as a function of population size and annual temperature at time $t$:
 \begin{equation}
 \ln(\frac{N_{t+1}}{N_t}) = T(N_t,K_t) = \beta^T_0 +  \beta^S_1 ln(N_t) +\beta^S_2 K_t + beta^S_3 {K_t}^2 +  \varepsilon
 \label{eqn:temporal_regression}
 \end{equation}
 
The temporal model returns a per capita growth rate on the log scale. To predict population size at the next time step, we simply exponentiate the growth rate and multiply it by the current population size: $exp(T(N_t,K_t)) N_t$.

The combined model is a weighted average of predictions from the spatial and temporal models, with the weights changing as a function of time, here expressed as the forecast horizon. The weights change as a function of the square root of the forecast horizon, to allow rapid shifts in the model weights. 
\begin{equation}
logit(\omega_t)=\beta^C_0 + \beta^C_1 \sqrt{t}
\label{eqn:weights}
\end{equation}
\begin{equation}
\hat{N}_{t+1} = \omega * exp(T(N_{t},K_t)) N_t + (1-\omega) * S(K_t) 
\label{eqn:combined_model}
\end{equation}

I used the \texttt{optim} function to estimate the $\beta^C$'s that minimize the sum of squared errors, $(\hat{N}_{t+1} - N_{t+1})^2$

\end{document}

